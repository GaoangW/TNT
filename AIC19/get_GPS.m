close all
clear
clc

addpath('C:\Users\tangz\OneDrive\Documents\Gaoang\General');
img_folder = 'C:\Users\tangz\OneDrive\Documents\Gaoang\AI_City_2019\test_img';
txt_folder = 'C:\Users\tangz\OneDrive\Documents\Gaoang\AI_City_2019\txt_result';
save_folder = 'C:\Users\tangz\OneDrive\Documents\Gaoang\AI_City_2019\txt_GPS_new';

H{6} = [-39.674660962698141 16.102883785990137 3146.771995805675488;...
    -0.934059457273461 0.173759814215439 55.457364632558139;...
    0.002792987003281 0.012330575092025 1.000000000000000];
H{7} = [-27.427113961042565 -39.189053665166234 -2389.953892327823723;...
    2.476953702287311 2.548626326045717 125.966417265179615;...
    -0.017764283728878 0.002702351308935 1.000000000000000];
H{8} = [-27.117578381188050 -31.068842452054415 -1666.398171587152092;...
    -2.501194891511217 -0.891844753792014 25.371909798986312;...
    -0.020102075707781 0.001607299732366 1.000000000000000];
H{9} = [-39.931762346875395 15.097050319357958 3066.432457736477318;...
    1.564708487880704 1.493191280606009 68.977560416958141;...
    0.001539740258468 0.011743673340779 1.000000000000000];
H{10} = [-57.080877324658289 110.154623467815000 12413.916301357161501;...
    -4.096094843673455 3.344557019293062 477.342478577084023;...
    0.007181304641579 0.014394191197496 1.000000000000000];
H{16} = [128.133462945774454 -83.127297796177700 -12982.930400032440957;...
    0.511840077966334 -0.600130159061754 -76.160718567949345;...
    -0.036659780965082 -0.006155111405097 1.000000000000000];
H{17} = [-98.860753035767473 1.560796517920175 4343.129781551265296;...
    -1.403499098793139 0.462368063093274 101.577205074013492;...
    -0.004613120841907 0.008866270088892 1.000000000000000];
H{18} = [-26.553728155364180 78.669239156738882 8261.857304863953686;...
    4.479536338934892 38.254605769441717 3278.353873678774562;...
    0.029580974360104 0.024893259989760 1.000000000000000];
H{19} = [-31.363030917118476 -19.206141461039671 -408.583682932941258;...
    -4.556800336887618 -1.395173391214593 67.155668367604321;...
    -0.015209237559659 0.003899720071171 1.000000000000000];
H{20} = [-25.859157413036971 9.166870706801658 1930.220413583786922;...
    3.348548053174832 6.836033317139322 477.542552152329620;...
    -0.002055341927177 0.010065055516616 1.000000000000000];
H{21} = [-163.675801192805011 48.694144314238429 11371.566474288763857;...
    0.274753672235635 -0.902739474888246 -93.538469047730885;...
    0.008423944256469 0.014976780120417 1.000000000000000];
H{22} = [-78.795802706024332 22.011927464865455 5344.815151285947650;...
    -0.003123482954017 0.001035106604063 0.230930073414519;...
    0.000831888308103 0.011417577855382 1.000000000000000];
H{23} = [-25.097566406257101 39.802881180689248 4675.978489734270624;...
    -12.303409477924886 17.231610847534860 2085.461595700654470;...
    0.010744452039061 0.016063280511130 1.000000000000000];
H{24} = [-31.982712829521788 -34.528924817341476 -1771.870815588646792;...
    -0.563094650053492 -0.336475374569115 -6.583136266448359;...
    -0.020976048626061 0.001196907193815 1.000000000000000];
H{25} = [-26.395413797809663 4.644062060336549 1542.908777332565023;...
    7.409235453044905 7.952015137739421 406.207310989456062;...
    -0.004136213269260 0.009089191126844 1.000000000000000];
H{26} = [-176.000602645298159 38.071963323363519 10932.280723125231816;...
    5.649225663732519 -4.315285876162802 -631.416235220450289;...
    0.005393838395312 0.013555613492782 1.000000000000000];
H{27} = [-238.819948856204661 26.958201726498078 12594.261498546298753;...
    8.895477254013622 -1.815361421010040 -542.662602693062809;...
    0.030413966140631 0.025279337107314 1.000000000000000];
H{28} = [-22.121688362556743 -3.663971408228670 607.857503139528376;...
    -0.152518803734172 -0.313187789532856 -21.919634076909730;...
    -0.009757691925452 0.006454126164614 1.000000000000000];
H{29} = [-185.935226922941723 -63.173381963044264 2172.675876810152204;...
    -12.018536638930323 -1.996550397531010 329.709590621312998;...
    -0.028404073587105 -0.002284099206778 1.000000000000000];
H{33} = [-183.805517226934199 -17.829574373674973 6194.577790169591026;...
    -0.993915114722652 -4.984825454272940 -409.869099491891632;...
    -0.016381148148967 0.003349959840897 1.000000000000000];
H{34} = [-35.686042572038296 -5.318025801720839 1034.327058853406243;...
    1.565147176948538 0.880311333023289 13.324631635828696;...
    -0.005946994153898 0.008239076845032 1.000000000000000];
H{35} = [-19.540908418770375 -260.100229497365376 -22759.612647358957474;...
    70.864517674665507 60.252891926805042 2453.012721309637072;...
    -0.182468171238089 -0.074478186210545 1.000000000000000];
H{36} = [-77.129640487527737 46.618826502261470 7506.150625581962231;...
    0.394193811723780 1.036911566063072 77.288921854980117;...
    -0.002930049891811 0.009652804397552 1.000000000000000];

cam_list = dir([txt_folder,'\*.txt']);
for n = 1:length(cam_list)
    cam_name = cam_list(n).name;
    cam_name = cam_name(1:4);
    cam_id = str2num(cam_name(2:end));
    img_path = [img_folder,'\',cam_name,'\000001.jpg'];
    img = imread(img_path);
    img_size = [size(img,2),size(img,1)];
    
    file_path = [txt_folder,'\',cam_name,'.txt'];
    fileID = fopen(file_path,'r');
    A = textscan(fileID,'%d %d %d %d %d %d %d %d %d','Delimiter',',');
    fclose(fileID);
    
    M = zeros(size(A{1},1),9);
    for m = 1:9
        M(:,m) = A{m};
    end
    M = double(M);
    bot_mid_pt = [M(:,3)+0.5*M(:,5),M(:,4)+M(:,6),ones(size(M,1),1)];
    GPS_loc = (pinv(H{cam_id})*bot_mid_pt')';
    GPS_loc = bsxfun(@times,GPS_loc,1./GPS_loc(:,3));
    M(:,8:9) = GPS_loc(:,1:2);
    
    save_path = [save_folder,'\',cam_name,'.txt'];
    fileID = fopen(save_path,'w');
    for r = 1:size(M,1)
        for c = 1:size(M,2)
            if c<8
                fprintf(fileID,'%d',M(r,c));
            else
                fprintf(fileID,'%f',M(r,c));
            end
            if c~=size(M,2)
                fprintf(fileID,',');
            else
                fprintf(fileID,'\n');
            end
        end
    end
end